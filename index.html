function doPost(e) {
  const sheetName = "Colaboradores";
  const spreadsheetId = "1a4X3m2zcXB0KT6eVl5tKl6WO-O9-pGHbP3hZzGRT3c0";
  const folderId = "1vYkgKVQCxRc_yKbWaymUThmJWBH0ySdR";
  
  try {
    // Verificar que hay datos
    if (!e || !e.postData || !e.postData.contents) {
      throw new Error("No se recibieron datos");
    }
    
    // Parsear los datos JSON
    const data = JSON.parse(e.postData.contents);
    
    // Validar campos obligatorios
    const requiredFields = [
      'rol', 'nombre', 'numero', 'fecha', 'email', 
      'vacaciones', 'jefe', 'correoJefe'
    ];
    
    const missingFields = requiredFields.filter(field => !data[field]);
    if (missingFields.length > 0) {
      throw new Error(`Faltan campos obligatorios: ${missingFields.join(', ')}`);
    }
    
    // Preparar los datos para la hoja
    const rowData = [
      data.timestamp || new Date().toISOString(), // Columna Id
      data.rol || '',
      data.nombre || '',
      "FIRMA_REGISTRADA", // Firma Colaborador
      data.numero || '',
      data.fecha || '',
      data.email || '',
      data.password || '',
      data.vacaciones === 'Sí' ? 'Sí' : 'No',
      data.jefe || '',
      data.correoJefe || '',
      "FIRMA_REGISTRADA", // Firma Jefe directo
      data.tituloEvento || '',
      Array.isArray(data.invitados) ? data.invitados.join(', ') : (data.invitados || ''),
      data.descripcion || '',
      data.mensaje || ''
    ];
    
    // Obtener la hoja de cálculo
    const spreadsheet = SpreadsheetApp.openById(spreadsheetId);
    let sheet = spreadsheet.getSheetByName(sheetName);
    
    // Crear hoja si no existe
    if (!sheet) {
      sheet = spreadsheet.insertSheet(sheetName);
      // Establecer los encabezados
      const headers = [
        "Id", "Rol", "Nombre del Colaborador", "Firma Colaborador",
        "Numero de Colaborador", "Fecha de ingreso", "Email", "Contraseña",
        "Se autorizan vacaciones (Si)", "Jefe directo", "Correo jefe directo",
        "Firma Jefe directo", "Titulo del evento", "Correos de invitados",
        "Descripcion", "Mensaje"
      ];
      sheet.appendRow(headers);
    }
    
    // Añadir los datos
    sheet.appendRow(rowData);
    
    // Opcional: Guardar las firmas como imágenes en Google Drive
    try {
      const folder = DriveApp.getFolderById(folderId);
      const timestamp = data.timestamp || new Date().toISOString().replace(/[:.]/g, '-');
      
      // Guardar firma colaborador
      if (data.firmaColaborador) {
        const firmaColab = Utilities.newBlob(
          Utilities.base64Decode(data.firmaColaborador.split(',')[1]), 
          'image/png', 
          `firma-colab-${data.nombre}-${timestamp}.png`
        );
        folder.createFile(firmaColab);
      }
      
      // Guardar firma jefe
      if (data.firmaJefe) {
        const firmaJefe = Utilities.newBlob(
          Utilities.base64Decode(data.firmaJefe.split(',')[1]), 
          'image/png', 
          `firma-jefe-${data.jefe}-${timestamp}.png`
        );
        folder.createFile(firmaJefe);
      }
    } catch (driveError) {
      console.error("Error al guardar firmas en Drive:", driveError);
      // No detenemos el proceso por este error
    }
    
    // Retornar respuesta exitosa
    return ContentService.createTextOutput(
      JSON.stringify({
        status: 'success',
        message: 'Datos guardados correctamente en Colaboradores'
      })
    ).setMimeType(ContentService.MimeType.JSON);

  } catch (error) {
    // Retornar error
    console.error("Error en doPost:", error);
    return ContentService.createTextOutput(
      JSON.stringify({
        status: 'error',
        message: error.message || 'Error desconocido al procesar la solicitud'
      })
    ).setMimeType(ContentService.MimeType.JSON);
  }
}

// Función de prueba mejorada
function testDoPost() {
  const mockData = {
    postData: {
      contents: JSON.stringify({
        rol: "Desarrollador",
        nombre: "Juan Pérez",
        numero: "DEV-123",
        fecha: "2023-01-15",
        email: "juan@empresa.com",
        password: "temp123",
        vacaciones: "Sí",
        jefe: "María Gómez",
        correoJefe: "maria@empresa.com",
        firmaColaborador: "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mP8z8BQDwAEhQGAhKmMIQAAAABJRU5ErkJggg==",
        firmaJefe: "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mP8z8BQDwAEhQGAhKmMIQAAAABJRU5ErkJggg==",
        tituloEvento: "Reunión de equipo",
        invitados: ["team@empresa.com", "hr@empresa.com"],
        descripcion: "Revisión de objetivos",
        mensaje: "Confirmar asistencia",
        timestamp: new Date().toISOString()
      })
    }
  };
  
  const result = doPost(mockData);
  Logger.log(result.getContent());
}
